# Introduction
S1APTester implements a UE(s) and eNodeB simulator for LTE Radio Access Networks
(RAN). The S1APTester is used to validate S1-C and S1-U Interfaces to an LTE
EPC.
It provides hooks for generating control and user plane procedures on the S1
Interface.

S1APTester is currently used as the S1 testing engine for the following
projects:
- [Magma](https://github.com/facebookincubator/magma): An open-source software
platform that gives network operators an open, flexible and extendable mobile
core network solution.

# Architecture
The Network Architecture of S1APTester is shown below

<img src="docs/img/arch.png" alt="drawing" width="700"/>

The S1APTester product contains the following components:

<img src="docs/img/modules.png" alt="drawing" width="700"/>

* Test Controller Framework (tfwApp)
  *	Exposes APIs towards the Test Controller Stub
  *	Responsible for configuring and interacting with UE Application and EnodeB
  Application layers
* UE Application (ueApp)
  *	Simulates the UE
  *	Maintains UE related configuration and call processing data. Also has state
  machines per UE
  *	Has NAS codec and security modules to build the NAS messages
* EnodeB Application (enbApp)
  *	Simulates the EnodeB functionality
  *	Maintains S1 Connection details
  *	Has S1AP and eGTP protocol stacks.
  *	Has TUCL Convergence layer, implements TCP and UDP layers
  *	Responsible for setting up of S1 Control and User plane
* Traffic Generator (Trfgen)
  *	Provides API for trigerring User plane traffic over LTE bearers of a
  simulated UE.
  *	It uses Iperf3 for traffic generation
* Test Controller Stub (TestStub)
  *	Contains example test cases which use the APIs provided by test framework
  for simulating various control and user plane procedures.
  *	Triggers various test case events towards Test Controller Framework (TFW)
  *	Receives and processes events from TFW


#	Compilation of S1APTester modules
S1APTester binary can be generated by executing below compilation steps:
## Compile S1SIM Application
```
$ cd TestCntlrApp/build
$ make cleanall
$ make
$ sudo cp ../lib/libtfw.so /usr/lib
$ cd ../../
```
On successful compilation, the “libtfw.so” library gets generated under
TestCntlrApp/lib folder which is copied to ``/usr/lib``.

##	Compile Traffic Generator
```
$ cd Trfgen/build
$ make clean
$ make
$ sudo cp ../lib/libtrfgen.so /usr/lib
$ cd ../../
```
On successful compilation, the “libtrfgen.so” library gets generated under
Trfgen/lib folder which is copied to ``/usr/lib``.

## Compile Test Controller Stub
```
$ cd TestCntlrStub/build
$ make clean
$ make
$ cd ../bin/
```
Upon successful compilation, an executable binary ``testCntrlr`` is created in the ``bin`` directory.


## Configure eNodeB Parameters
Example eNodeB configuration file can be found in ``TestCntlrApp/cfg/nbAppCfg.txt``,

In this file you will need to put in the parameters for your EPC, such as Cell ID, TAC, MCC/MNC, IP Addresses, etc.

## Configure UE Parameters
Example UE parameter file can be found in ``TestCntlrApp/cfg/ueCfg.txt``,

In this file you will need to put in the crypto parameters for your HSS, such as OP key and K Keys.

Each IMSI you want to test will need to be defined in  ``TestCntlrApp/cfg/imsi.txt``

## Running S1AP Test
After configuring your eNodeB & UE parameters, you can run the ``TestCntlrStub`` with one of the example test cases,
```
$ cd TestCntlrStub/bin
$ sudo ./testCntrlr -f testCaseList_1.txt
```

Log messages will be shown on screen and in the text file ``log`` created in the same directory.



# Testing with Magma
Following points should be considered when using S1APTester with
[Magma](https://github.com/facebookincubator/magma)

## UE IP Address Configuration
While testing with [Magma](https://github.com/facebookincubator/magma) setup,
the current configuration parameters in Magma allow allocation of only 243 UE
IP addresses. We need to change the configuration in Magma codebase, in order
to support allocation of more than 243 UE IP addresses.

The following mask value, i.e., 24 needs to be changed in the file:
[s1ap_wrapper.py](https://github.com/facebookincubator/magma/blob/master/lte/gateway/python/integ_tests/s1aptests/s1ap_wrapper.py)
(Filepath: [magma/lte/gateway/python/integ_tests/s1aptests/s1ap_wrapper.py](https://github.com/facebookincubator/magma/blob/master/lte/gateway/python/integ_tests/s1aptests/s1ap_wrapper.py))
```
TEST_IP_BLOCK = "192.168.128.0/24"
```

Magma has reserved 11 IP addresses for internal purpose and 2 IP addresses
(Subnet Zero and All-Ones Subnet) are not allocatable. Therefore, with the mask
value of n, the maximum number of UE IP addresses allowed will be
((2^(32-n)) - 13).

```
Example:
For the mask value of 24, maximum number of allowed UE IP addresses = ((2^(32-24)) - 13) = 243
For the mask value of 20, maximum number of allowed UE IP addresses = ((2^(32-20)) - 13) = 4083
For the mask value of 17, maximum number of allowed UE IP addresses = ((2^(32-17)) - 13) = 32755
```
Decreasing the mask value will provide more number of UE IP addresses in the
free IP address pool.

## License

S1APTester is BSD License licensed, as found in the LICENSE file.
